#!/bin/sh

ssh='ssh -oCheckHostIP=no -oStrictHostKeyChecking=no -i/tmp/experiment/id_rsa'

# figure out experiment name
exp="`awk '/^NAME/ { print $2}' /tmp/experiment/setup-data`"

# like echo, but with timestamps
msg() {
    echo "`TZ=GMT date +%H:%M:%S`  $*"
}

# run an experiment for each requested size
while read size
do
    msg "Running experiments, size=$size"
    # we need the file to be identical on all servers,
    # so we make one up here and copy to all servers
    dd if=/dev/urandom bs=1048576 count=$size of=/tmp/datafile || continue
    while read what type number host port user
    do
	[ "$what" = NODE ] || continue
	[ "$type" = server ] || continue
	rsync -avHPe "$ssh -p$port" /tmp/datafile $user@$host:/tmp/datafile < /dev/null
    done < /tmp/experiment/setup-data
    echo
    ls /tmp/experiment | \
	awk -F- '$1 == "start" && NF > 1 {print $2}' | \
	sort -u | \
	while read experiment
    do
	for schedule in /tmp/experiment/schedule-*
	do
	    schedule="${schedule##*schedule-}"
	    if [ -f /tmp/only-run ]
	    then
		grep -q "^$experiment\\.$schedule\$" /tmp/only-run || continue;
	    fi
	    # make sure the 1-minute load average on all nodes is back to its
	    # baseline value (probably 0) before we start this experiment
	    msg "Sleeping 60 seconds to let load average return to baseline level"
	    sleep 60
	    rm -r /tmp/results /tmp/logs >/dev/null 2>&1
	    mkdir /tmp/results /tmp/logs
	    echo
	    msg "Running experiment=$experiment schedule=$schedule size=$size"
	    # start the experiment
	    while read what type number host port user
	    do
		[ "$what" = NODE ] || continue
		[ "$type" = server -o "$type" = client -o "$type" = router ] || continue
		sshrun="$ssh -p$port $user@$host -n"
		$sshrun /tmp/experiment/start "$schedule" "$experiment" \
		    "$type" "$number" "$size" &
	    done < /tmp/experiment/setup-data
	    # wait for all clients to report completion
	    echo "$experiment $schedule $size" > /tmp/current-experiment
	    msg "Experiment started, waiting for client results"
	    previous=''
	    while true
	    do
		ok=''
		waiting=''
		while read what type number host port user
		do
		    [ "$what" = NODE ] || continue
		    [ "$type" = client ] || continue
		    if [ -f "/tmp/results/$type$number.$experiment.$schedule.$size" ]
		    then
			ok="$ok $number"
		    else
			waiting="$waiting $number"
		    fi
		done < /tmp/experiment/setup-data
		if [ ".$waiting" = . ]
		then
		    msg 'All client results received'
		    break
		fi
		if [ ".$ok" = . ]
		then
		    message="WAIT:$waiting"
		else
		    message="OK:$ok --- WAIT:$waiting"
		fi
		if [ ".$previous" != ".$message" ]
		then
		    msg "$message"
		    previous="$message"
		fi
		sleep 2
	    done
	    # make sure all copies are complete, not just started
	    msg Waiting to make sure all rsyncs completed
	    sleep 4
	    msg "Stopping experiment"
	    while read what type number host port user
	    do
		[ "$what" = NODE ] || continue
		[ -x "/tmp/experiment/stop-$experiment-$type" ] || continue
		sshrun="$ssh -p$port $user@$host -n"
		$sshrun "/tmp/experiment/stop-$experiment-$type"
	    done < /tmp/experiment/setup-data
	    msg "Experiment stopped, waiting for server/router results"
	    previous=''
	    while true
	    do
		ok=''
		waiting=''
		while read what type number host port user
		do
		    [ "$what" = NODE ] || continue
		    [ "$type" = client ] && continue
		    [ "$type" = director ] && continue
		    if [ -f "/tmp/results/$type$number.$experiment.$schedule.$size" ]
		    then
			ok="$ok $type$number"
		    else
			waiting="$waiting $type$number"
		    fi
		done < /tmp/experiment/setup-data
		if [ ".$waiting" = . ]
		then
		    msg 'All results received'
		    break
		fi
		if [ ".$ok" = . ]
		then
		    message="WAIT:$waiting"
		else
		    message="OK:$ok; WAIT:$waiting"
		fi
		if [ ".$previous" != ".$message" ]
		then
		    msg "$message"
		    previous="$message"
		fi
		sleep 2
	    done
	    # make sure all copies are complete, not just started
	    msg Waiting to make sure all rsyncs completed
	    sleep 4
	    # create result tarballs and copy them to server
	    msg "Copying results to server"
	    tarball="/tmp/$exp-$experiment-$schedule-$size-`date +%Y%m%d%H%M%S`.tar.gz"
	    tar czf "$tarball" -C /tmp/results .
	    scp -oCheckHostIP=no -oStrictHostKeyChecking=no -i/tmp/experiment/id_rsa \
		-P722 "$tarball" jfed@f4fresults.w42.org:results/
	    rm "$tarball"
	    tar czf "$tarball" -C /tmp/logs .
	    scp -oCheckHostIP=no -oStrictHostKeyChecking=no -i/tmp/experiment/id_rsa \
		-P722 "$tarball" jfed@f4fresults.w42.org:logs/
	    rm "$tarball"
	    # clean up
	    rm -r /tmp/results /tmp/logs
	done
    done
done < /tmp/experiment/sizes

