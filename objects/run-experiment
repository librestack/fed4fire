#!/bin/sh

ssh='ssh -oCheckHostIP=no -oStrictHostKeyChecking=no -i/tmp/experiment/id_rsa'

# figure out experiment name
exp="`awk '/^NAME/ { print $2}' /tmp/experiment/setup-data`"

# run an experiment for each requested size
while read size
do
    echo "Running experiments, size=$size"
    # we need the file to be identical on all servers,
    # so we make one up here and copy to all servers
    dd if=/dev/urandom bs=1048576 count=$size of=/tmp/datafile || continue
    while read what type number host port user
    do
	[ "$what" = NODE ] || continue
	[ "$type" = server ] || continue
	rsync -avHPe "$ssh -p$port" /tmp/datafile $user@$host:/tmp/datafile < /dev/null
    done < /tmp/experiment/setup-data
    ls /tmp/experiment | \
	awk -F- '$1 == "start" && NF > 1 {print $2}' | \
	sort -u | \
	while read experiment
    do
	for schedule in /tmp/experiment/schedule-*
	do
	    schedule="${schedule##*schedule-}"
	    # make sure the 1-minute load average on all nodes is back to its
	    # baseline value (probably 0) before we start this experiment
	    sleep 60
	    rm -r /tmp/results >/dev/null 2>&1
	    mkdir /tmp/results
	    echo "Running experiment=$experiment schedule=$schedule size=$size"
	    # start the experiment
	    while read what type number host port user
	    do
		[ "$what" = NODE ] || continue
		[ "$type" = server -o "$type" = client -o "$type" = router ] || continue
		sshrun="$ssh -p$port $user@$host -n"
		$sshrun /tmp/experiment/start "$schedule" "$experiment" \
		    "$type" "$number" "$size" &
	    done < /tmp/experiment/setup-data
	    # wait for all clients to report completion
	    echo "Experiment started, waiting for client results"
	    waiting=true
	    prn=true
	    while $waiting
	    do
		waiting=false
		sleep 2
		while read what type number host port user
		do
		    [ "$what" = NODE ] || continue
		    [ "$type" = client ] || continue
		    [ -f "/tmp/results/$type$number.$experiment.$schedule.$size" ] && \
			continue
		    $prn && echo "Waiting for $type $number..."
		    waiting=true
		done < /tmp/experiment/setup-data
		prn=false
	    done
	    echo "Stopping experiment"
	    while read what type number host port user
	    do
		[ "$what" = NODE ] || continue
		[ -x "/tmp/experiment/stop-$experiment-$type" ] || continue
		sshrun="$ssh -p$port $user@$host -n"
		$sshrun "/tmp/experiment/stop-$experiment-$type"
	    done < /tmp/experiment/setup-data
	    echo "Experiment stopped, waiting for server/router results"
	    waiting=true
	    prn=true
	    while $waiting
	    do
		waiting=false
		sleep 2
		while read what type number host port user
		do
		    [ "$what" = NODE ] || continue
		    [ "$type" = director ] && continue
		    [ -f "/tmp/results/$type$number.$experiment.$schedule.$size" ] && \
			continue
		    $prn && echo "Waiting for $type $number..."
		    waiting=true
		done < /tmp/experiment/setup-data
		prn=false
	    done
	    # create result tarball
	    echo "Copying results to server"
	    tarball="/tmp/$exp-$experiment-$schedule-$size-`date +%Y%m%d%H%M%S`.tar.gz"
	    tar czf "$tarball" -C /tmp/results .
	    # copy tarball back to server
	    scp -oCheckHostIP=no -oStrictHostKeyChecking=no -i/tmp/experiment/id_rsa \
		-P722 "$tarball" jfed@ams2.uilebheist.fr:results/
	    # clean up
	    rm -r /tmp/results
	    rm "$tarball"
	done
    done
done < /tmp/experiment/sizes

