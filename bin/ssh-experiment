#!/usr/bin/perl -w

use strict;
use File::Temp;

my @opts;
@ARGV && $ARGV[0] eq -'v' and push @opts, shift @ARGV;

@ARGV >= 2 or die "Usage: $0 EXP_NAME [DIR] NODE [PROGRAM_TO_RUN]\n";
my $EXP = shift @ARGV;
my $NODE = shift @ARGV;
my $DIR = "/var/tmp";
if ($NODE =~ m|^/|) {
    @ARGV >= 1 or die "Usage: $0 EXP_NAME [DIR] NODE [PROGRAM_TO_RUN]\n";
    $DIR = $NODE;
    $NODE = shift @ARGV;
}
my @RUN = @ARGV;

my $dir = "$DIR/$EXP/ansible";
my $cf = 'ssh-config';

chdir $dir or die "$dir: $!\n";
stat $cf or die "$dir/$cf: $!\n";
-f _ or die "$dir/$cf: not a regular file\n";

exec 'ssh', '-F', $cf, @opts, $NODE, @RUN;
die "Could not exec ssh: $!\n";

