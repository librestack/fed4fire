#!/usr/bin/perl -w

use strict;
use Cwd 'abs_path';

while (@ARGV) {
    my $name = shift @ARGV;
    my $path = abs_path($name);
    defined $path or die "Something wrong with $name\n";
    $path =~ m|/\w+\.(\w+)\.(\w+)\.(\d+)\.(\d+)$|
	or die "Invalid datafile name: $name\n";
    my ($experiment, $schedule, $size, $run) = ($1, $2, $3, $4);
    system('lwmon-to-sql',
	   '-tlwmon_data',
	   '-Hhost',
	   "-eexperiment=$experiment",
	   "-eschedule=$schedule",
	   "-edatasize=$size",
	   "-erun=$run",
	   '-stimestamp',
	   '-nname',
	   '-pparm',
	   '-kkey',
	   '-dvalue',
	   $path) == 0 and next;
    $? == -1 and die "lwmon-to-sql: $!\n";
    $? & 0x7f and die 'lwmon-to-sql killed by signal ' . ($? & 0x7f) . "\n";
    die 'lwmon-to-sql exited with status ' . ($? >> 8) . "\n";
}

