#!/usr/bin/perl -w

use strict;
use FindBin '$Bin';

my $usage = "Usage: $0 EXP_NAME [DIR] NODE RSYNC_OPTIONS REMOTE_SOURCE [REMOTE_SOURCE]... LOCAL_DEST\n";
@ARGV >= 5 or die $usage;
my $EXP = shift @ARGV;
my $NODE = shift @ARGV;
my $DIR = "/var/tmp";
if ($NODE =~ m|^/|) {
    @ARGV >= 4 or die $usage;
    $DIR = $NODE;
    $NODE = shift @ARGV;
}
my $OPTS = shift @ARGV;
my $DEST = pop @ARGV;
my @SOURCES = @ARGV;

my $ssh;
for my $path ($Bin, split(/:/, $ENV{PATH})) {
    -f "$path/ssh-experiment" or next;
    -x _ or next;
    $ssh = "$path/ssh-experiment";
    last;
}
defined $ssh or die "Cannot find ssh-experiment in $Bin or PATH\n";

$ssh = "$ssh $EXP";

@SOURCES = map { "$NODE:$_" } @SOURCES;
my @OPTS = ($OPTS eq '' ? () : split(/\s+/, $OPTS));
my @rsync = ('rsync', "-e$ssh", @OPTS, @SOURCES, $DEST);
exec @rsync;

