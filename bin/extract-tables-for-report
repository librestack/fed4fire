#!/bin/bash -e

# makes an extract from the summary tables (see "make-online-summaries") to
# generate the tables to be included in the report ("report/experiment.tex")

if [ $# -ne 2 ]
then
    echo "usage: `basename "$0"` SUMMARIES_DIRECTORY TEX_DIRECTORY" >&2
    exit 1
fi

input="$1"
output="$2"

cp "$input/20-all/run-time.tex" "$output/run-time-20-all.tex"
cp "$input/20-3routers/run-time.tex" "$output/run-time-20-lans.tex"
cp "$input/20-single/run-time.tex" "$output/run-time-20-single.tex"
cp "$input/40-all/run-time.tex" "$output/run-time-40-all.tex"
cp "$input/40-multiple/run-time.tex" "$output/run-time-40-lans.tex"
cp "$input/40-single/run-time.tex" "$output/run-time-40-single.tex"
cp "$input/50-single/run-time.tex" "$output/run-time-50-single.tex"
awk '(NR < 30 || (NR > 540 && NR < 560) || /^\\/ || /^TIME/) { print }\
     (NR == 31) { print "\\multicolumn7{|c|}{\\ldots}\\\\" }' \
    "$input/router-S1R3L5C-20220131083908/router.tex" > "$output/router1.tex"
awk '((NR > 19 && NR < 38) || (NR > 125 && NR < 158) || /^\\/ || /^TIME/) { print }\
     (NR == 41) { print "\\multicolumn7{|c|}{\\ldots}\\\\" }' \
    "$input/router-S1R3L10H-20220311052100/router.tex" > "$output/router2.tex"

# the remaining tables were generated by joining togther two files for each table
# and this may not be the most legible command line you'll ever see

# apart from the pasting and editing, each file server-UPDATE.tex comes from
# update-UPDATE/server-tx.tex and update-UPDATE/server-load.tex

join() {
    local u="$1"
    local f="$2"
    if [ ".$f" = . ]
    then
	f='{\
	    if (/\\sc/) { \
		print " & \\multicolumn5{c|}{Network TX} & \\multicolumn5{c|}{Server load}\\\\" \
	    } \
	    print \
	}'
    else
	f='{ \
	    if (/\\sc/) { \
		print " & \\multicolumn5{c|}{Network TX} & \\multicolumn5{c|}{Server load}\\\\" \
	    } \
	    if (/^ *[0-9]/) {
		if ($1=='$f') { \
		    print " & \\multicolumn5{c|}{\\ldots} & \\multicolumn5{c|}{\\ldots}\\\\" \
		} \
		if ($1<'$f') {print} \
	    } \
	    else { \
		if (/^[^ ]/) {print} \
	    } \
	}'
    fi
    paste -d' ' \
	"$input/update-$u/server-tx.tex" \
	"$input/update-$u/server-load.tex" | \
    tr A-Z a-z | \
    sed -e 's/\\\\ *[0-9][0-9]* & / \&/' \
	-e 's/\\\\ {\\sc\\#clients}//' \
	-e 's/   */ /' \
	-e 's/\\\\/ &/' \
	-e 's/^\\begin.*$/\\begin{tabular}{|r|rrrrr|rrrrr|}/' \
	-e 's/^\\hline.*$/\\hline/' \
	-e 's/^\\end.*$/\\end{tabular}/' \
	-e 's/} \\\\/}\\\\/' \
	| \
    awk "$f" > "$output/server-$u.tex"
}

join multicast ''
join scp ''
join tcp ''
join udp 52

